name: Algora Autopost

on:
  schedule:
    # Morning post: 07:00 UTC = 10:00 MSK
    - cron: "0 7 * * *"
    # Afternoon post: 11:00 UTC = 14:00 MSK
    - cron: "0 11 * * *"
    # Evening post: 15:00 UTC = 18:00 MSK
    - cron: "0 15 * * *"
  workflow_dispatch:
    inputs:
      post_type:
        description: "Post type to run"
        required: false
        default: "auto"
        type: choice
        options:
          - auto
          - product
          - niche_review
          - weekly_top
          - beginner_mistake
          - product_of_week
      dry_run:
        description: "Dry run (no publish)"
        required: false
        default: false
        type: boolean

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  post:
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: "pip"

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Restore data cache
        uses: actions/cache/restore@v4
        with:
          path: |
            data/algora.db
            data/wb_cache.json
            data/products_cache.json
            data/dashboard.html
          key: algora-data-${{ github.ref_name }}-${{ github.run_id }}
          restore-keys: |
            algora-data-${{ github.ref_name }}-
            algora-data-

      - name: Ensure data dir
        run: mkdir -p data

      - name: Create .env from secrets
        run: |
          cat > .env << 'ENVEOF'
          ANTHROPIC_API_KEY=${{ secrets.ANTHROPIC_API_KEY }}
          TELEGRAM_BOT_TOKEN=${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHANNEL_ID=${{ secrets.TELEGRAM_CHANNEL_ID }}
          APIFY_API_TOKEN=${{ secrets.APIFY_API_TOKEN }}
          VK_API_TOKEN=${{ secrets.VK_API_TOKEN }}
          VK_GROUP_ID=236000213
          ENVEOF

      - name: Determine post type
        id: decide
        run: |
          POST_TYPE="${{ github.event.inputs.post_type || 'auto' }}"
          if [ "$POST_TYPE" = "auto" ]; then
            # Auto-select based on day of week
            DOW=$(date -u +%u)  # 1=Mon, 7=Sun
            HOUR=$(date -u +%H)
            # 3 posts/day: 07:00 (morning), 11:00 (afternoon), 15:00 (evening) UTC
            if [ "$DOW" = "7" ] && [ "$HOUR" -ge "14" ]; then
              # Sunday evening = weekly top
              POST_TYPE="weekly_top"
            elif [ "$DOW" = "3" ] && [ "$HOUR" -lt "8" ]; then
              # Wednesday morning = niche review
              POST_TYPE="niche_review"
            elif [ "$DOW" = "5" ] && [ "$HOUR" -lt "8" ]; then
              # Friday morning = beginner mistake
              POST_TYPE="beginner_mistake"
            elif [ "$DOW" = "6" ] && [ "$HOUR" -ge "10" ] && [ "$HOUR" -lt "12" ]; then
              # Saturday afternoon = product of week
              POST_TYPE="product_of_week"
            elif [ "$DOW" = "2" ] && [ "$HOUR" -ge "10" ] && [ "$HOUR" -lt "12" ]; then
              # Tuesday afternoon = niche review
              POST_TYPE="niche_review"
            elif [ "$DOW" = "4" ] && [ "$HOUR" -ge "14" ]; then
              # Thursday evening = beginner mistake
              POST_TYPE="beginner_mistake"
            else
              # All other slots = regular product post
              POST_TYPE="product"
            fi
          fi
          echo "post_type=$POST_TYPE" >> "$GITHUB_OUTPUT"
          echo "Selected post type: $POST_TYPE"

      - name: Check secrets availability
        run: |
          echo "--- Secrets diagnostic ---"
          if [ -z "${{ secrets.ANTHROPIC_API_KEY }}" ]; then
            echo "WARNING: ANTHROPIC_API_KEY is not set! AI insights will be skipped."
          else
            echo "OK: ANTHROPIC_API_KEY is set"
          fi
          if [ -z "${{ secrets.TELEGRAM_BOT_TOKEN }}" ]; then
            echo "WARNING: TELEGRAM_BOT_TOKEN is not set!"
          else
            echo "OK: TELEGRAM_BOT_TOKEN is set"
          fi
          if [ -z "${{ secrets.VK_API_TOKEN }}" ]; then
            echo "WARNING: VK_API_TOKEN is not set! VK posting will be skipped."
          else
            echo "OK: VK_API_TOKEN is set"
          fi
          if [ -z "${{ secrets.APIFY_API_TOKEN }}" ]; then
            echo "WARNING: APIFY_API_TOKEN is not set! Will fall back to demo data."
          else
            echo "OK: APIFY_API_TOKEN is set"
          fi
          echo "DB exists: $(test -f data/algora.db && echo 'yes' || echo 'no')"
          echo "DB size: $(stat -c%s data/algora.db 2>/dev/null || echo 'N/A')"
          echo "--- End diagnostic ---"

      - name: Run post
        env:
          PYTHONIOENCODING: utf-8
        run: |
          POST_TYPE="${{ steps.decide.outputs.post_type }}"
          DRY_RUN="${{ github.event.inputs.dry_run || 'false' }}"
          DRY_FLAG=""
          if [ "$DRY_RUN" = "true" ]; then
            DRY_FLAG="--dry-run"
          fi

          case "$POST_TYPE" in
            product)
              python -X utf8 -m scripts.run_pipeline --source 1688 --top 1 $DRY_FLAG
              ;;
            niche_review)
              # Pick a random category
              CATS=("electronics" "gadgets" "home" "phone_accessories" "car_accessories" "led_lighting" "beauty_devices" "smart_home" "outdoor" "toys" "health" "kitchen" "pet" "sport" "office" "kids" "bags" "jewelry" "tools" "stationery")
              CAT=${CATS[$RANDOM % ${#CATS[@]}]}
              python -X utf8 -m scripts.post_niche_review --category "$CAT" --source 1688 $DRY_FLAG
              ;;
            weekly_top)
              python -X utf8 -m scripts.post_weekly_top $DRY_FLAG
              ;;
            beginner_mistake)
              python -X utf8 -m scripts.post_beginner_mistake --source 1688 $DRY_FLAG
              ;;
            product_of_week)
              python -X utf8 -m scripts.post_product_of_week --source 1688 $DRY_FLAG
              ;;
          esac

      - name: Update engagement & save stats
        if: always()
        env:
          PYTHONIOENCODING: utf-8
        run: python -X utf8 -m scripts.analytics --update-engagement --save

      - name: Generate dashboard
        if: always()
        env:
          PYTHONIOENCODING: utf-8
        run: python -X utf8 -m scripts.dashboard

      - name: Prepare Pages directory
        if: always()
        run: |
          mkdir -p _site
          cp data/dashboard.html _site/index.html

      - name: Upload Pages artifact
        if: always()
        uses: actions/upload-pages-artifact@v3
        with:
          path: _site

      - name: Save data cache
        if: always()
        uses: actions/cache/save@v4
        with:
          path: |
            data/algora.db
            data/wb_cache.json
            data/products_cache.json
            data/dashboard.html
          key: algora-data-${{ github.ref_name }}-${{ github.run_id }}

  deploy-dashboard:
    needs: post
    if: always()
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deploy.outputs.page_url }}
    steps:
      - name: Deploy to GitHub Pages
        id: deploy
        uses: actions/deploy-pages@v4
